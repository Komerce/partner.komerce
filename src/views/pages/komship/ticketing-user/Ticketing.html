<b-card>
    <div
        class="py-1 px-2"
        style="
            border: 1px solid #E2E2E2;
            border-radius: 16px;
        "
    >
        <b-row class="mb-1">
            <h3 class="text-black">
                <strong>
                    Buat Tiket
                </strong>
            </h3>
        </b-row>

        <validation-observer
            ref="formRules"
        >
            <b-form>
                <b-row>
            
                <b-col md="6">
                    <b-form-group>
                        <template #label>
                            <span class="text-black">
                                <strong>
                                    Nomor Resi
                                </strong>
                            </span>
                        </template>
                        <validation-provider
                            #default="{errors}"
                            name="Nomor Resi"
                            rules="required"
                        >
                            <v-select
                                v-model="itemsNoResi"
                                :options="itemsResi"
                                label="no_resi"
                                :state="errors.length > 0 ? false:null"
                                @input="fetchDataResi"
                                @search="cekResi"
                            />
                            <small class="text-primary">{{ errors[0] }}</small>
                        </validation-provider>
                    </b-form-group>
                </b-col>

                <b-col md="6">
                    <b-form-group>
                        <template #label>
                            <span class="text-black">
                                <strong>
                                    Jenis Tiket
                                </strong>
                            </span>
                        </template>
                        <validation-provider
                            #default="{errors}"
                            name="Jenis Tiket"
                            rules="required"
                        >
                            <v-select
                                v-model="ticketType"
                                :options="jenisTicketItems"
                                :state="errors.length > 0 ? false:null"
                                @input="fetchJenisTicket"
                            />
                            <small class="text-primary">{{ errors[0] }}</small>
                        </validation-provider>
                    </b-form-group>
                </b-col>

                <b-col md="6">
                    <b-form-group>
                    <template #label>
                        <span>
                            Customer
                        </span>
                    </template>
                    <b-form-input
                        v-model="customerName"
                        placeholder="Nama Customer"
                        disabled
                    />
                    </b-form-group>

                    <!-- Put File -->
                    <label
                        v-if="itemsImageInitialFile[0] === undefined"
                        for="formFile"
                        class="text-info btn btn-flat-info p-0"
                    >
                        <div class="d-flex align-items-center">
                            <div>
                                <feather-icon
                                    icon="FileIcon"
                                    size="20"
                                    class="mr-50 text-info"
                                />
                            </div>
                            Lampirkan File
                        </div>
                    </label>
                    <b-form-file
                        id="formFile"
                        v-model="imageFile"
                        placeholder="Choose a file or drop it here..."
                        drop-placeholder="Drop file here..."
                        multiple
                        class="d-none"
                        @change="onChangeFile"
                    />

                    <!-- Preview File -->
                    <b-row
                        v-for="(items, index) in itemsImageInitialFile"
                        :key="index+1"
                        class="align-items-center"
                    >
                        <label
                            class="text-info btn btn-flat-info p-0 ml-1"
                        >
                            <div class="d-flex align-items-center">
                                <div>
                                    <feather-icon
                                        icon="FileIcon"
                                        size="20"
                                        class="mr-50 text-info"
                                    />
                                </div>
                                <a id="previewImage" :href="fileUrl(items)" target="_blank" class="text-info">
                                    {{ items.name }}
                                </a>
                            </div>
                        </label>
                        <b-button
                            variant="flat-dark"
                            class="btn-icon"
                            size="sm"
                            @click="deleteFile(items)"
                        >
                            <feather-icon
                                icon="Trash2Icon"
                                size="20"
                                class="text-black"
                            />
                        </b-button>
                    </b-row>
                </b-col>

                <b-col md="6">
                    <b-form-group>
                        <template #label>
                            <span class="text-black">
                                <strong>
                                    Deskripsi
                                </strong>
                            </span>
                        </template>
                        <validation-provider
                            #default="{errors}"
                            name="Deskripsi"
                            rules="required"
                        >
                            <b-form-textarea
                                v-model="description"
                                rows="3"
                                :state="errors.length > 0 ? false:null"
                            />
                            <small class="text-primary">{{ errors[0] }}</small>
                        </validation-provider>
                    </b-form-group>
                </b-col>

                <b-col
                    md="12"
                    class="mt-50"
                >
                    <b-row class="justify-content-end mr-50">
                        <b-button
                            variant="outline-primary"
                            class="btn-icon mr-1"
                            @click="clearFieldTicket"
                        >
                            Batalkan
                        </b-button>
                        <b-button
                            class="btn-icon"
                            variant="primary"
                            @click="alertSubmitTicket"
                        >
                            Buat Tiket
                        </b-button>
                    </b-row>
                </b-col>
            
                </b-row>
            </b-form>
        </validation-observer>
    </div>

    <b-row class="my-2">
        <h3 class="text-black ml-1">
            <strong>
                Tiket Pengiriman
            </strong>
        </h3>
    </b-row>

    <div
        class="py-1 px-2 mb-2"
        style="
            border: 1px solid #E2E2E2;
            border-radius: 16px;
        "
    >
        <b-row class="mx-50 my-2">
            <div
                class="d-flex justify-content-center align-items-center mr-2"
                style="
                    background: #FCD4BE;
                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.12);
                    border-radius: 12px;
                    width: 240px;
                    height: 102px;
                "
            >
                <div
                    class="text-center"
                >
                    <p
                        class="mt-1"
                        style="
                            color: #AB2900;
                            font-weight: 500;
                            font-size: 16px;
                        "
                    >
                        Perlu Tindak Lanjut
                    </p>
                    <p
                        class="mt-1"
                        style="
                            color: #AB2900;
                            font-weight: 400;
                            font-size: 20px;
                        "
                    >
                        {{ perluTindakLanjut }}
                    </p>
                </div>
            </div>

            <div
                class="d-flex justify-content-center align-items-center mr-2"
                style="
                    background: #FFEDED;
                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.12);
                    border-radius: 12px;
                    width: 240px;
                    height: 102px;
                "
            >
                <div
                    class="text-center"
                >
                    <p
                        class="mt-1"
                        style="
                            color: #E31A1A;
                            font-weight: 500;
                            font-size: 16px;
                        "
                    >
                        Belum Diproses
                    </p>
                    <p
                        class="mt-1"
                        style="
                            color: #E31A1A;
                            font-weight: 400;
                            font-size: 20px;
                        "
                    >
                        {{ belumDiProses }}
                    </p>
                </div>
            </div>

            <div
                class="d-flex justify-content-center align-items-center"
                style="
                    background: #FCEBBE;
                    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.12);
                    border-radius: 12px;
                    width: 240px;
                    height: 102px;
                "
            >
                <div
                    class="text-center"
                >
                    <p
                        class="mt-1"
                        style="
                            color: #FBA63C;
                            font-weight: 500;
                            font-size: 16px;
                        "
                    >
                        Sedang Diproses
                    </p>
                    <p
                        class="mt-1"
                        style="
                            color: #FBA63C;
                            font-weight: 400;
                            font-size: 20px;
                        "
                    >
                        {{ sedangDiProses }}
                    </p>
                </div>
            </div>
        </b-row>
    </div>

    <b-row class="justify-content-end mb-1">
        <b-col
            md="4"
            class="pr-0"
        >
          <b-input-group class="input-group-merge">
            <b-input-group-prepend is-text>
              <feather-icon icon="SearchIcon" />
            </b-input-group-prepend>
            <b-form-input
                v-model="search"
                placeholder="Search"
                @input="searchTicket"
            />
          </b-input-group>
        </b-col>

        <b-col
            md="auto"
        >
            <b-button
                id="popoverStatus"
                v-ripple.400="'rgba(113, 102, 240, 0.15)'"
                variant="flat-dark"
                style="border: 1px solid #C2C2C2;
                border-radius: 8px;"
            >
                <b-row class="align-items-center justify-content-between">
                    {{ searchType.label }}
                    <div class="ml-3">
                        <b-img src="@/assets/images/icons/arrow-filter.svg" />
                    </div>
                </b-row>
            </b-button>
            <b-popover
                id="popover-search-type"
                target="popoverStatus"
                triggers="focus"
                placement="bottom"
            >
                <div
                    v-for="(items, index) in searchItems"
                    :key="index+1"
                >
                    <b-button
                        v-model="items.value"
                        variant="flat-dark"
                        @click="setSearchType(items)"
                    >
                        {{ items.label }}
                    </b-button>
                </div>
            </b-popover>
        </b-col>
    </b-row>

    <b-row class="justify-content-end mb-2">
        <b-col
            md="auto"
            class="pr-0"
        >
            <b-button
                id="popoverJenisTicket"
                v-ripple.400="'rgba(113, 102, 240, 0.15)'"
                variant="flat-dark"
                style="border: 1px solid #C2C2C2;
                border-radius: 8px;"
            >
                <b-row class="align-items-center justify-content-between">
                    Jenis Tiket
                    <div class="ml-3">
                        <b-img src="@/assets/images/icons/arrow-filter.svg" />
                    </div>
                </b-row>
            </b-button>
            <b-popover
                target="popoverJenisTicket"
                triggers="focus"
                placement="bottom"
            >
                <div
                    class="p-50"
                    v-for="(item, index) in ticketTypeItems"
                    :key="index+1"
                >
                    <b-form-checkbox
                        v-model="item.onCheck"
                        class="custom-control-primary mb-1"
                        @change="filterByTicketType(item)"
                    >
                        <span class="text-black">
                            {{ item.name }}
                        </span>
                    </b-form-checkbox>
                </div>
            </b-popover>
        </b-col>

        <b-col
            md="auto"
            class="pr-0"
        >
            <b-button
                id="popoverStatusTicket"
                v-ripple.400="'rgba(113, 102, 240, 0.15)'"
                variant="flat-dark"
                style="border: 1px solid #C2C2C2;
                border-radius: 8px;"
            >
                <b-row class="align-items-center justify-content-between">
                    Status Tiket
                    <div class="ml-3">
                        <b-img src="@/assets/images/icons/arrow-filter.svg" />
                    </div>
                </b-row>
            </b-button>
            <b-popover
                target="popoverStatusTicket"
                triggers="focus"
                placement="bottom"
            >
                <div
                    class="p-50"
                    v-for="(items, index) in ticketStatusItems"
                    :key="index+1"
                >
                    <b-form-checkbox
                        v-model="items.onCheck"
                        class="custom-control-primary mb-1"
                        @change="filterTicketByStatus(items)"
                    >
                        <span class="text-black">
                            {{ items.label }}
                        </span>
                    </b-form-checkbox>
                </div>
            </b-popover>
        </b-col>

        <b-col
            class="pr-0"
            md="2"
        >
            <date-range-picker
              ref="picker"
              v-model="dateRange"
              :locale-data="locale"
              :ranges="ranges"
              :opens="'left'"
              class="w-100"
            >
              <template
                v-slot:input="picker"
                style="min-width: 350px"
              >
                <div
                  class="d-flex justify-content-between align-items-center w-100"
                >
                    <div>
                        <span class="text-black">Waktu Dibuat</span>
                    </div>
                    <div>
                        <b-img src="@/assets/images/icons/arrow-filter.svg" />
                    </div>
                </div>
              </template>
            </date-range-picker>
        </b-col>

        <b-col
            md="2"
        >
            <date-range-picker
                ref="picker"
                v-model="dateRangeUpdate"
                :locale-data="locale"
                :ranges="ranges"
                :opens="'left'"
                class="w-100"
            >
                <template
                    v-slot:input="picker"
                    style="min-width: 350px"
                >
                    <div
                        class="d-flex justify-content-between align-items-center w-100"
                    >
                        <span class="text-black">Waktu Diupdate</span>
                        <div class="">
                            <b-img src="@/assets/images/icons/arrow-filter.svg" />
                        </div>
                    </div>
                </template>
            </date-range-picker>
        </b-col>

        <div>
            <b-button
                variant="outline-primary"
                class="btn-icon mr-1"
                @click="clearFilter"
            >
                Hapus Filter
            </b-button>
        </div>
    </b-row>

    <!-- Data table -->
    <b-overlay
        :show="loadingDataTable"
        spinner-variant="primary"
        variant="light"
        blur="0"
        opacity=".5"
        rounded="sm"
    >
        <b-row>
            <b-table
                :items="itemsTicket"
                :fields="fieldsTicket"
                show-empty
                empty-text="Tidak ada data yang ditampilkan."
                responsive
                selectable
                @row-selected="onRowSelected"
            >
                <template #cell(ticket_no)="dataNoTicket">
                    <span class="text-primary font-medium">
                        {{ dataNoTicket.value }}
                    </span>
                </template>
    
                <template #cell(no_resi)="dataNomorResi">
                    <span class="text-black font-medium">
                        {{ dataNomorResi.value }}
                    </span>
                </template>
    
                <template #cell(shipping)="dataShipping">
                    <span class="text-black font-medium">
                        {{ dataShipping.item.shipping }}
                    </span>
                </template>
    
                <template #cell(customer_name)="dataCustomer">
                    <span class="text-black font-medium">
                        {{ dataCustomer.value }}
                    </span>
                </template>
    
                <template #cell(name)="dataJenisticket">
                    <span class="text-black font-medium">
                        {{ dataJenisticket.value}}
                    </span>
                </template>
    
                <template #cell(ticket_status)="dataStatusTicket">
                    <span
                        v-if="dataStatusTicket.value === 'Perlu tindak lanjut'"
                        class="font-medium"
                        style="color: #AB2900" 
                    >
                        Perlu Tindak Lanjut
                    </span>
                    <span
                        :class="statusTicketClass(dataStatusTicket.value)"
                    >
                        {{ convertTicketStatus(dataStatusTicket.value) }}
                    </span>
                </template>
    
                <template #cell(date_created)="dataWaktuDibuat">
                    <span class="text-black font-medium">
                        {{ dataWaktuDibuat.value }}
                    </span>
                </template>
    
                <template #cell(date_updated)="dataWaktuDiupdate">
                    <span class="text-black font-medium">
                        {{ dataWaktuDiupdate.value }}
                    </span>
                </template>
            </b-table>
        </b-row>

        <b-row>
            <b-col
                cols="12"
                class="d-flex justify-content-between"
            >
                <div
                    class="bg-light d-flex justify-content-center align-items-center p-50 rounded"
                >
                    <span class="text-black mr-50">
                        List per halaman:
                    </span>
                    <b-button
                        v-for="page in optionsPage"
                        :key="page"
                        class="btn-icon"
                        size="sm"
                        :variant="totalPerPage === page ? 'primary' : 'flat-dark'"
                        @click="setPerPage(page)"
                    >
                        {{ page }}
                    </b-button>
                </div>

                <b-pagination
                    v-model="currentPage"
                    :total-rows="totalRows"
                    :per-page="totalPerPage"
                    first-number
                    last-number
                    class="pagination-primary"
                >
                    <template #prev-text>
                        <feather-icon
                            size="18"
                            icon="ChevronLeftIcon"
                        />
                    </template>
                    <template #next-text>
                        <feather-icon
                            size="18"
                            icon="ChevronRightIcon"
                        />
                    </template>
                </b-pagination>
            </b-col>
        </b-row>
    </b-overlay>

    <!-- Popup success create ticket -->
    <b-modal
        ref="popup-success-create-ticket"
        variant="primary"
        no-close-on-backdrop
        no-close-on-esc
        centered
        hide-header
        hide-footer
    >
        <b-row class="justify-content-center mb-2 pt-2">
            <b-img src="@/assets/images/icons/success.svg" />
        </b-row>

        <b-row class="justify-content-center mb-2">
            <span class="text-black text-center">
                <strong>
                    Tiket kendala berhasil dibuat
                </strong>
            </span>
        </b-row>

        <b-row class="justify-content-center pb-2">
            <b-col md="4">
                <b-button
                        variant="primary"
                        block
                        @click="closeSuccessCreateTicket"
                    >
                        Oke
                    </b-button>
            </b-col>
        </b-row>
    </b-modal>

    <!-- Alert validate ticket -->
    <b-modal
        ref="alert-validate-ticket"
        variant="primary"
        no-close-on-backdrop
        no-close-on-esc
        centered
        hide-header
        hide-footer
    >
        <b-row class="justify-content-center mb-2 pt-2">
            <b-img src="@/assets/images/icons/warning.svg" />
        </b-row>

        <b-row class="justify-content-center mb-2">
            <span class="text-black text-center">
                <strong>
                    Kamu tidak bisa mengedit tiket ini setelah dikirim. Pastikan Informasi yang kamu masukkan sudah sesuai
                </strong>
            </span>
        </b-row>

        <b-row class="justify-content-center pb-2">
            <b-col
                md="4"
                class="pr-0 mr-1"
            >
                <b-button
                        variant="outline-primary"
                        block
                        @click="closeAlertSubmitTicket"
                    >
                        Cek Lagi
                </b-button>
            </b-col>
            <b-col
                md="4"
                class="pl-0"
            >
                <b-button
                        variant="primary"
                        block
                        @click="submitTicket"
                    >
                        <b-spinner
                            v-if="loadingSubmitTicket"
                            small
                        />
                        lanjutkan
                </b-button>
            </b-col>
        </b-row>
    </b-modal>
</b-card>